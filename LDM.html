<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LDM Hesap â€“ KarÄ±ÅŸÄ±k Ã–lÃ§Ã¼ler (Multi-SKU) + KG</title>
<style>
  :root{ --truckLdm:13.6; --truckW:2.4; --truckL:13.6; }
  body{font-family:system-ui,Arial,sans-serif;background:#f6f7f9;margin:24px}
  .wrap{max-width:1200px;margin:auto;background:#fff;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:22px}
  h1{margin:0 0 8px;font-size:22px}
  .note{font-size:12px;color:#667085;margin:6px 0 14px}
  fieldset{border:1px solid #e6e7eb;border-radius:12px;margin:14px 0;padding:14px}
  legend{padding:0 8px;color:#444}
  .controls{display:flex;gap:10px;align-items:end;flex-wrap:wrap}
  select,input{width:100%;padding:10px 12px;border:1px solid #d7d8dd;border-radius:10px;font-size:14px}
  .btn{background:#2563eb;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:left;padding:8px 10px}
  thead th{font-size:12px;color:#475569}
  tbody tr{background:#f8fafc;border:1px solid #e5e7eb}
  tbody td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .del{background:#ef4444;border:none;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
  .results{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
  .card{background:#f1f4f8;border:1px solid #e3e7ee;border-radius:12px;padding:10px}
  .card b{display:block;font-size:12px;color:#475569}
  .big{font-size:18px;font-weight:800;margin-top:6px}
  .warn{margin-top:10px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:8px 10px;border-radius:8px;display:none}
  .truckbox{margin-top:16px}
  .bar{position:relative;height:26px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:10px;overflow:hidden}
  .slice{position:absolute;top:0;bottom:0}
  .slice.over{background:red !important;opacity:0.6}
  .badge{margin-top:6px;font-size:12px;color:#334155}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .legend span{display:inline-flex;align-items:center;gap:6px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;font-size:12px}
  .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
  .topwrap{margin-top:18px}
  .tophead{display:flex;align-items:center;gap:10px;justify-content:space-between}
  canvas{display:block;background:#fff;border:1px solid #e5e7eb;border-radius:10px}
  .overflow{margin-top:8px;color:#9a3412;background:#ffedd5;border:1px solid #fed7aa;padding:8px 10px;border-radius:8px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>LDM & mÂ³ â€“ KarÄ±ÅŸÄ±k Ã–lÃ§Ã¼ler (KG dahil)</h1>
  <div class="note">Kabul: 1 LDM = 1750 kg â€¢ 1 mÂ³ = 333 kg â€¢ Treyler iÃ§i: 2.40 m Ã— 13.60 m (13.6 LDM)</div>

  <fieldset>
    <legend>AraÃ§ ve GÃ¶rÃ¼nÃ¼m</legend>
    <div class="controls">
      <div style="min-width:220px">
        <label>AraÃ§ tipi</label>
        <select id="arac">
          <option value="standart" selected>Standart (2.80 m)</option>
          <option value="mega">Mega (3.00 m)</option>
          <option value="kapali">KapalÄ± Kasa (2.65 m)</option>
        </select>
      </div>
      <div style="min-width:260px">
        <label>Ãœstten GÃ¶rÃ¼nÃ¼m</label>
        <select id="simMode">
          <option value="ldm" selected>Sadece LDM dilimleri</option>
          <option value="greedy">YaklaÅŸÄ±k yerleÅŸim (greedy)</option>
        </select>
      </div>
      <button class="btn" id="add">Kalem Ekle</button>
      <button class="btn" id="calc">Hesapla</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Kalemler (farklÄ± Ã¶lÃ§Ã¼ler)</legend>
    <table id="tbl">
      <thead>
        <tr>
          <th>Renk</th>
          <th>En (cm)</th>
          <th>Boy (cm)</th>
          <th>YÃ¼k (cm)</th>
          <th>Adet</th>
          <th>Ä°stif?</th>
          <th>KG (manuel/otomatik)</th>
          <th>Sil</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </fieldset>

  <div class="results">
    <div class="card"><b>Toplam LDM (istife gÃ¶re)</b><div class="big" id="ldmT">-</div></div>
    <div class="card"><b>Toplam mÂ³</b><div class="big" id="m3T">-</div></div>
    <div class="card"><b>Toplam CHW</b><div class="big" id="chwT">-</div></div>
  </div>

  <div class="warn" id="warn"></div>

  <div class="truckbox">
    <div class="bar" id="bar"></div>
    <div class="badge" id="barText">0.0 / 13.6 LDM (%0)</div>
    <div class="legend" id="legend"></div>
  </div>

  <div class="topwrap">
    <div class="tophead">
      <div><b>Ãœstten GÃ¶rÃ¼nÃ¼m (2.40 m Ã— 13.60 m)</b></div>
      <div id="orientInfo" class="note">-</div>
    </div>
    <canvas id="cv" width="952" height="168"></canvas>
    <div class="overflow" id="overflow"></div>
  </div>
</div>

<script>
const EL = id => document.getElementById(id);
const TRUCK_W = 2.4, TRUCK_L = 13.6, TRUCK_LDM = 13.6;
const COLORS = ["#60a5fa","#f59e0b","#34d399","#f472b6","#a78bfa","#fb7185","#22d3ee","#84cc16","#f97316","#38bdf8","#e879f9","#4ade80"];
let colorIdx = 0;

// ðŸš› Kapasiteler
const CAPACITY = {
  standart: { ldm: 13.6, chw: 24000 }, 
  mega:     { ldm: 13.6, chw: 26000 },
  kapali:   { ldm: 13.6, chw: 22000 }
};

function innerH(t){
  if(t==='mega') return 3.0;
  if(t==='kapali') return 2.65;
  return 2.8;
}

function ldmPer(en,boy){
  if ((en===80 && boy===120) || (en===120 && boy===80)) return 0.4;
  if ((en===100 && boy===120) || (en===120 && boy===100)) return 0.5;
  if (en===120 && boy===120) return 0.6;
  return (en/100)*(boy/100)/2.4;
}

function addRow(data={}){
  const tr = document.createElement('tr');
  const color = data.color || COLORS[colorIdx++ % COLORS.length];
  tr.innerHTML = `
    <td><input type="color" value="${color}" class="clr"></td>
    <td><input type="number" class="en" placeholder="80" value="${data.en||''}"></td>
    <td><input type="number" class="boy" placeholder="120" value="${data.boy||''}"></td>
    <td><input type="number" class="yuk" placeholder="140" value="${data.yuk||''}"></td>
    <td><input type="number" class="adet" placeholder="10" value="${data.adet||''}"></td>
    <td>
      <select class="istif">
        <option value="hayir" ${data.istif==='hayir'?'selected':''}>HayÄ±r</option>
        <option value="evet" ${data.istif==='evet'?'selected':''}>Evet</option>
      </select>
    </td>
    <td><input type="number" class="kg" placeholder="Kg gir" value="${data.kg||''}"></td>
    <td><button class="del">Sil</button></td>
  `;
  EL('rows').appendChild(tr);
  tr.querySelector('.del').onclick = ()=>{ tr.remove(); calc(); };
  ['en','boy','yuk','adet','istif','clr','kg'].forEach(cls=>{
    tr.querySelectorAll('.'+cls).forEach(el=>{
      el.addEventListener('change', calc);
      el.addEventListener('keyup', e=>{ if(e.key==='Enter') calc(); });
    });
  });
}

function readRows(){
  const rows = [];
  EL('rows').querySelectorAll('tr').forEach(tr=>{
    const en = Number(tr.querySelector('.en').value);
    const boy = Number(tr.querySelector('.boy').value);
    const yuk = Number(tr.querySelector('.yuk').value);
    const adet = Number(tr.querySelector('.adet').value);
    const istif = tr.querySelector('.istif').value;
    const color = tr.querySelector('.clr').value;
    const kgInput = Number(tr.querySelector('.kg').value);
    if([en,boy,yuk,adet].every(v=>v>0)){
      rows.push({en,boy,yuk,adet,istif,color,kgInput,tr});
    }
  });
  return rows;
}

function calc(){
  const items = readRows();
  const hIn = innerH(EL('arac').value);
  if(items.length===0){ resetVis(); return; }

  let totalLdm=0, totalM3=0, totalChw=0;
  items.forEach(it=>{
    const ldmP = ldmPer(it.en,it.boy);
    const layers = it.istif==='evet' ? Math.max(1, Math.floor(hIn/(it.yuk/100))) : 1;
    const baseCount = Math.ceil(it.adet / layers);
    const m3 = (it.en/100)*(it.boy/100)*(it.yuk/100)*it.adet;
    const ldm = ldmP * baseCount;

    let chw;
    if(it.kgInput > 0){
      chw = it.kgInput;
    } else {
      chw = m3 * 333;
      it.tr.querySelector('.kg').value = Math.round(chw);
    }

    it.m3 = m3;
    it.ldmEq = ldm;
    it.chw = chw;

    totalLdm += ldm;
    totalM3  += m3;
    totalChw += chw;
  });

  EL('ldmT').textContent = totalLdm.toFixed(2) + ' LDM';
  EL('m3T').textContent  = totalM3.toFixed(2) + ' mÂ³';
  EL('chwT').textContent = Math.round(totalChw).toLocaleString('tr-TR') + ' kg';

  const type = EL('arac').value;
  const maxCap = CAPACITY[type];
  let overCap = false;
  if (totalLdm > maxCap.ldm || totalChw > maxCap.chw) {
    overCap = true;
    EL('warn').style.display = 'block';
    EL('warn').textContent = `âš ï¸ ${type.toUpperCase()} aracÄ±nÄ±n kapasitesi aÅŸÄ±ldÄ±! (Max: ${maxCap.ldm} LDM / ${maxCap.chw.toLocaleString('tr-TR')} kg)`;
  } else {
    EL('warn').style.display = 'none';
  }

  drawBar(items, totalLdm, overCap);

  const mode = EL('simMode').value;
  if(mode==='ldm') drawTopSlices(items, totalLdm, overCap);
  else drawGreedy(items, overCap);
}

function resetVis(){
  EL('ldmT').textContent='-';
  EL('m3T').textContent='-';
  EL('chwT').textContent='-';
  EL('bar').innerHTML='';
  EL('legend').innerHTML='';
  EL('barText').textContent='0.0 / 13.6 LDM (%0)';
  const cv = EL('cv').getContext('2d');
  cv.clearRect(0,0,EL('cv').width,EL('cv').height);
  EL('overflow').style.display='none';
  EL('orientInfo').textContent='-';
}

function drawBar(items,totalLdm,overCap){
  const bar = EL('bar'); bar.innerHTML='';
  const cap = TRUCK_LDM;
  let x=0;
  items.forEach(it=>{
    const wPct = Math.min(100, (it.ldmEq/cap)*100);
    const div = document.createElement('div');
    div.className='slice'+(overCap?' over':'');
    div.style.left = x+'%';
    div.style.width = wPct+'%';
    div.style.background = it.color;
    div.title = `${it.en}Ã—${it.boy} (${it.adet} ad.) = ${it.ldmEq.toFixed(2)} LDM`;
    bar.appendChild(div);
    x += wPct;
  });
  const pct = Math.max(0, Math.min(100, (totalLdm/cap)*100));
  EL('barText').textContent = `${totalLdm.toFixed(2)} / ${cap} LDM (%${pct.toFixed(0)})`;
}

function drawTopSlices(items,totalLdm,overCap){
  const c = EL('cv'), ctx = c.getContext('2d'); const S=60;
  c.width = Math.round(TRUCK_L*S); c.height=Math.round(TRUCK_W*S);
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle=overCap?'#fecaca':'#f8fafc'; 
  ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle='#e5e7eb'; ctx.strokeRect(0,0,c.width,c.height);
  let x=0;
  items.forEach(it=>{
    const len = (it.ldmEq)*S;
    ctx.fillStyle=overCap?'red':it.color; ctx.globalAlpha=0.6;
    ctx.fillRect(x,0,Math.min(len,c.width-x),c.height);
    ctx.globalAlpha=1;
    ctx.strokeStyle='#334155'; ctx.strokeRect(x,0,Math.min(len,c.width-x),c.height);
    ctx.fillStyle='#0f172a'; ctx.font='12px system-ui';
    ctx.fillText(`${it.en}Ã—${it.boy} â†’ ${it.ldmEq.toFixed(2)} LDM`, x+6, 14);
    x+=len;
  });
  EL('orientInfo').textContent = overCap?'âš ï¸ Kapasite AÅŸÄ±ldÄ±':'GÃ¶rsel: LDM dilimleri';
}

function drawGreedy(items,overCap){
  const c = EL('cv'), ctx = c.getContext('2d'); const S=60;
  c.width=Math.round(TRUCK_L*S); c.height=Math.round(TRUCK_W*S);
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle=overCap?'#fecaca':'#fff'; ctx.fillRect(0,0,c.width,c.height);
  ctx.strokeStyle='#e5e7eb'; ctx.strokeRect(0,0,c.width,c.height);
  ctx.fillStyle=overCap?'red':'#0f172a'; ctx.font='14px system-ui'; ctx.fillText(overCap?'âš ï¸ Kapasite AÅŸÄ±ldÄ±':'Deneysel yerleÅŸim',10,20);
}

EL('add').onclick = ()=> addRow({});
EL('calc').onclick = calc;
['arac','simMode'].forEach(id=> EL(id).addEventListener('change', calc));

(function seed(){
  addRow({en:80,boy:120,yuk:140,adet:10,istif:'evet'});
  addRow({en:100,boy:120,yuk:150,adet:8,istif:'hayir'});
  addRow({en:120,boy:120,yuk:160,adet:6,istif:'evet'});
  calc();
})();
</script>
</body>
</html>
